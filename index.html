<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.G.E - Brigada HSM (Sistema Final)</title>
    
    <!-- √çcones Antigos (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- √çcones Novos (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false, 
            }
        }
    </script>
    
    <style>
        /* === VARI√ÅVEIS GERAIS (SISTEMA BASE) === */
        :root {
            --sidebar-bg: #0f172a;
            --main-bg: #f3f4f6;
            --card-bg: #ffffff;
            --primary-red: #dc2626;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --info-blue: #3b82f6;
            
            /* Vari√°veis Premium - Indicadores */
            --ind-primary: #2563eb;
            --ind-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --ind-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --ind-transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Vari√°veis da Escala */
            --escala-header: #1e293b;
            --escala-accent: #f97316;
            --sd-bg: #dcfce7; --sd-txt: #166534;
            --sn-bg: #dbeafe; --sn-txt: #1e40af;
            --f-bg: #f8fafc;  --f-txt: #94a3b8;
            --ferias-bg: #ffedd5; --ferias-txt: #9a3412;
            --border-light: #e2e8f0;

            /* Vari√°veis Treinamento */
            --radius: 10px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body { display: flex; height: 100vh; background-color: var(--main-bg); overflow: hidden; }

        /* === SISTEMA DE EDI√á√ÉO === */
        [contenteditable="true"] { outline: none; transition: background 0.2s; border-radius: 4px; padding: 2px 4px; border: 1px dashed transparent; }
        [contenteditable="true"]:hover { background-color: rgba(249, 115, 22, 0.1); cursor: text; border-color: #cbd5e1; }
        [contenteditable="true"]:focus { background-color: white; box-shadow: 0 0 0 2px var(--escala-accent); color: #1e293b; min-width: 20px; display: inline-block; }

        .icon-editable { cursor: pointer; transition: 0.2s; padding: 3px; border-radius: 4px; }
        .icon-editable:hover { color: var(--escala-accent); background: rgba(255,255,255,0.1); transform: scale(1.1); box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.5); }

        /* === SIDEBAR === */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; transition: 0.3s; z-index: 100; }
        .brand { padding: 0 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand h2 { font-size: 16px; font-weight: 800; letter-spacing: 0.5px; }
        .brand span { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; display: block; margin-top: 4px; }
        
        .user-profile { padding: 24px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-red); cursor: pointer; }
        .user-info h4 { font-size: 14px; color: #fff; }
        .user-info p { font-size: 10px; color: var(--primary-red); font-weight: bold; text-transform: uppercase; }

        .nav-menu { list-style: none; margin-top: 10px; flex: 1; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: #94a3b8; text-decoration: none; font-size: 14px; transition: 0.3s; cursor: pointer; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: white; background: rgba(255,255,255,0.05); border-left: 4px solid var(--primary-red); }
        .nav-item i { width: 24px; text-align: center; margin-right: 10px; }

        .logout { padding: 20px 24px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .logout:hover { color: var(--primary-red); }

        /* === MAIN CONTENT AREA & VIEW CONTROL === */
        .main-content { flex: 1; padding: 24px 32px; overflow-y: auto; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        
        /* Regra padr√£o para ativar views */
        .view-section.active { display: block; }
        
        /* CORRE√á√ÉO DO BUG DA INVAS√ÉO: Regra espec√≠fica para o container de Indicadores */
        /* O Tailwind 'flex' estava conflitando, agora controlamos aqui */
        #view-indicadores.active {
            display: flex !important;
            flex-direction: column;
            height: 100%;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === DASHBOARD CSS === */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header-title h1 { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        
        .status-pill { background: rgba(16, 185, 129, 0.1); color: var(--success-green); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 6px; height: 6px; background: var(--success-green); border-radius: 50%; }
        .date-info { font-size: 12px; color: var(--text-secondary); font-weight: 500; text-align: right; line-height: 1.4; }

        .top-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; margin-bottom: 24px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); position: relative; transition: all 0.3s; border: 1px solid var(--border-light); }
        
        .welcome-card { background: linear-gradient(90deg, rgba(26,31,54,0.9) 0%, rgba(26,31,54,0.4) 100%), url('https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?auto=format&fit=crop&q=80&w=800'); background-size: cover; background-position: center; color: white; display: flex; flex-direction: column; justify-content: center; }
        .metric-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }

        /* Timeline Styles */
        .timeline-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
        .timeline-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .icon-green { background: rgba(16, 185, 129, 0.1); color: var(--success-green); }
        .icon-orange { background: rgba(245, 158, 11, 0.1); color: var(--warning-orange); }
        .icon-blue { background: #dbeafe; color: #1e40af; }
        .icon-red { background: #fee2e2; color: #991b1b; }

        /* Plant√£o Widget */
        .team-card { background-color: #1e293b; color: white; border-radius: 12px; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        .team-list { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; flex: 1; overflow-y: auto; max-height: 350px; }
        .team-member { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.05); transition: 0.2s; }
        .team-member:hover { background: rgba(255,255,255,0.1); }
        .team-member img { width: 36px; height: 36px; border-radius: 50%; }

        /* === ESCALA === */
        .section-dark-header { background: var(--escala-header); color: white; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--escala-accent); margin-bottom: 20px; }
        
        .escala-container { display: flex; flex-direction: column; gap: 16px; }
        .month-control { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; gap: 15px; backdrop-filter: blur(5px); }
        .nav-arrow { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .escala-actions button { background-color: var(--escala-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.85rem; margin-left: 10px; }
        .btn-reset { background-color: #475569 !important; }

        .table-paper { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid var(--border-light); }
        .table-scroll { overflow-x: auto; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 1200px; }
        th, td { padding: 8px 4px; text-align: center; border-right: 1px solid var(--border-light); border-bottom: 1px solid var(--border-light); font-size: 0.75rem; }
        .th-days { background-color: #334155; color: white; height: 35px; }
        .th-week { background-color: #f8fafc; color: #334155; font-weight: 800; font-size: 0.7rem; }
        .col-sticky { position: sticky; left: 0; z-index: 10; background-color: #f1f5f9; width: 180px; text-align: left; padding-left: 10px; font-weight: 600; }
        .col-id { position: sticky; left: 180px; z-index: 10; background-color: #f8fafc; width: 50px; font-family: monospace; color: #64748b; }
        .section-header-row { background: linear-gradient(90deg,#1e40af 0%,#1e3a8a 100%); color: white; text-align: left; padding: 6px 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        .cell-status { cursor: pointer; font-weight: 700; transition: 0.1s; user-select: none; }
        .cell-status:hover { transform: scale(1.15); z-index: 10; box-shadow: 0 0 4px rgba(0,0,0,0.2); }
        .st-sd { background-color: var(--sd-bg); color: var(--sd-txt); }
        .st-sn { background-color: var(--sn-bg); color: var(--sn-txt); }
        .st-f  { background-color: var(--f-bg);  color: var(--f-txt); }
        .st-ferias { background-color: var(--ferias-bg); color: var(--ferias-txt); font-size: 0.65rem; }
        .weekend-col { background-image: linear-gradient(to bottom,rgba(148,163,184,0.12),rgba(248,250,252,0.3)); }
        
        .footer-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-top: 5px; }
        .check-card { background: white; border-radius: 12px; border: 1px solid var(--border-light); display: flex; flex-direction: column; overflow: hidden; }
        .card-title-purple { background-color: #7c3aed; color: white; padding: 6px; text-align: center; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; }
        .task-row { display: flex; border-bottom: 1px solid #f1f5f9; padding: 4px 8px; font-size: 0.75rem; justify-content: space-between; }
        .alert-box { background-color: #fef9c3; color: #854d0e; padding: 8px; text-align: center; font-size: 0.7rem; margin-top: auto; border-top: 1px solid #fde047; }

        /* === TREINAMENTOS === */
        .training-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .training-filters { display: flex; gap: 10px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); align-items: center; }
        .filter-btn { background: transparent; border: none; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .filter-btn.active { background: #1e293b; color: white; }
        
        .training-progress-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 15px 20px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .fill { height: 100%; background: #ef4444; width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        .module-list { display: flex; flex-direction: column; gap: 16px; }
        .module-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); overflow: hidden; transition: all 0.3s ease; }
        .module-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .module-card.done-border { border-left: 4px solid #10b981; }

        .card-header { padding: 1.25rem 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: white; }
        .header-left { display: flex; align-items: center; gap: 20px; flex: 1; }
        .card-body { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1); background: #fff; }
        .module-card.active .card-body { max-height: 2000px; }
        .module-card.active .card-header { background: #f8fafc; border-bottom: 1px solid var(--border-light); }
        
        .status-dot-t { width: 24px; height: 24px; border-radius: 50%; background: #f1f5f9; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center; color: transparent; font-size: 12px; transition: all 0.3s; }
        .status-dot-t.done { background: #10b981; border-color: #10b981; color: white; }
        
        .badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge.lid { background: #f3e8ff; color: #7e22ce; }
        .badge.tec { background: #e0f2fe; color: #0369a1; }
        .badge.comp { background: #dcfce7; color: #15803d; }
        .badge.seg { background: #fee2e2; color: #991b1b; }
        
        .expand-icon { color: #94a3b8; transition: transform 0.3s; font-size: 0.9rem; margin-left: 15px; }
        .module-card.active .expand-icon { transform: rotate(180deg); color: #1e293b; }

        .content-wrapper { padding: 2.5rem; display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 3rem; }
        .training-h4 { font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; margin-bottom: 1.2rem; font-weight: 700; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .theory-block li { list-style: none; margin-bottom: 16px; font-size: 0.95rem; line-height: 1.6; color: #475569; padding-left: 15px; border-left: 2px solid var(--border-light); }
        .drill-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 12px; position: relative; }
        .drill-box::before { content: ''; position: absolute; left: 0; top: 15px; bottom: 15px; width: 4px; background: #ef4444; border-radius: 0 4px 4px 0; }
        
        .action-btn { background: white; color: var(--text-primary); border: 1px solid #cbd5e1; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; float: right; margin-top: 20px;}
        .action-btn:hover { background: #f1f5f9; border-color: #94a3b8; }
        .action-btn.completed { background: #10b981; color: white; border-color: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

        .mistake-alert { margin-top: 1.5rem; padding: 1rem; background: #fef2f2; border-radius: 8px; color: #b91c1c; font-size: 0.85rem; display: flex; gap: 10px; align-items: flex-start; }

        /* === EQUIPAMENTOS === */
        .equip-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .equip-box { background: white; border-radius: 12px; border: 1px solid var(--border-light); overflow: hidden; }
        .equip-box-header { padding: 15px; font-weight: 700; color: white; display: flex; justify-content: space-between; align-items: center; }
        .bg-ext { background: #ef4444; } .bg-hid { background: #3b82f6; } .bg-luz { background: #f59e0b; }
        .equip-table { width: 100%; border-collapse: collapse; }
        
        .equip-table td { 
            padding: 8px 12px; 
            border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem;
            vertical-align: middle; 
            height: 40px; 
        }
        
        .equip-table [contenteditable="true"] {
            min-height: 20px; 
            display: block;
            width: 100%;
        }

        .btn-add-eq { background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        /* === NORMAS === */
        .normas-intro-box { background: white; padding: 25px; border-radius: 12px; border-left: 5px solid var(--escala-accent); margin-bottom: 20px; }
        .normas-menu-item { background: white; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .normas-menu-item:hover { background: #f8fafc; transform: translateX(5px); }
        .normas-menu-item.active { background: #1e293b; color: white; border-color: #1e293b; }
        .normas-content-box { display: none; background: #f8fafc; padding: 20px; border: 1px solid #e2e8f0; border-top: none; margin-top: -8px; border-radius: 0 0 8px 8px; color: #475569; line-height: 1.6; }

        /* === F√âRIAS === */
        .soon-container { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; text-align: center; }
        .soon-icon { font-size: 4rem; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* === RELAT√ìRIO === */
        .report-paper { background: white; width: 100%; max-width: 900px; margin: 0 auto; padding: 60px; box-shadow: 0 0 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; min-height: 1000px; position: relative; }
        .doc-header { text-align: center; border-bottom: 2px solid #1e293b; padding-bottom: 20px; margin-bottom: 40px; }
        .doc-title { font-size: 1.4rem; font-weight: 800; color: #1e293b; text-transform: uppercase; letter-spacing: 1px; }
        .doc-subtitle { font-size: 0.9rem; color: #64748b; margin-top: 5px; font-weight: 500; }
        .doc-section { margin-bottom: 30px; }
        .doc-h3 { font-size: 1rem; color: var(--primary-red); border-left: 4px solid var(--primary-red); padding-left: 10px; margin-bottom: 15px; font-weight: 700; text-transform: uppercase; }
        .doc-text { font-size: 0.95rem; line-height: 1.6; color: #334155; text-align: justify; margin-bottom: 10px; white-space: pre-line; }

        /* Modal Picker */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .picker-box { background: white; padding: 20px; border-radius: 12px; width: 350px; max-height: 70vh; overflow-y: auto; }
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; }
        .icon-opt { font-size: 1.2rem; padding: 10px; text-align: center; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; color: #64748b; }
        .icon-opt:hover { background: var(--primary-red); color: white; }

        /* === ESTILOS PREMIUM DO NOVO PAINEL DE INDICADORES === */
        
        .card-interactive { 
            transition: all var(--ind-transition); 
            cursor: pointer; 
            border: 1px solid transparent; 
            position: relative; 
            overflow: hidden; 
        }
        
        .card-interactive:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--ind-shadow-lg); 
            border-color: #cbd5e1; 
        }
        
        /* Bot√µes de Filtro Slicer */
        .slicer-btn { 
            background: white; 
            border: 1px solid #e2e8f0; 
            color: #64748b; 
            font-weight: 600; 
            transition: all 0.2s; 
            text-transform: uppercase; 
            letter-spacing: 0.025em; 
            cursor: pointer; 
            border-radius: 6px;
        }
        .slicer-btn:hover { background: #f8fafc; border-color: #cbd5e1; color: #334155; }
        .slicer-active { background: var(--ind-primary) !important; border-color: var(--ind-primary) !important; color: white !important; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        
        /* KPI Cards Premium */
        .kpi-card { 
            background: white; 
            padding: 1.5rem; 
            border-radius: 1rem; 
            border: 1px solid #e2e8f0; 
            box-shadow: var(--shadow-sm); 
            position: relative; 
            overflow: hidden; 
        }
        .kpi-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; line-height: 1; color: #0f172a; font-variant-numeric: tabular-nums; }
        
        /* Cards de Insight com Efeito Glass */
        .insight-card { 
            background: rgba(248, 250, 252, 0.8); 
            border: 1px solid #e2e8f0; 
            padding: 0.85rem; 
            border-radius: 0.5rem; 
            display: flex; 
            gap: 0.75rem; 
            align-items: start; 
            transition: all 0.2s; 
            backdrop-filter: blur(4px);
        }
        .insight-card:hover { background: white; box-shadow: var(--shadow-md); transform: translateX(4px); border-color: #cbd5e1; }
        .insight-icon { color: var(--ind-primary); font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; }

        /* Container do Painel */
        .ind-container { width: 100%; height: 100%; display: flex; flex-direction: column; background: #f8fafc; }
        
        /* Texto com Gradiente */
        .text-gradient {
            background: var(--ind-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Pulse Animation */
        .pulse-dot {
            width: 0.5rem; height: 0.5rem; border-radius: 50%; background: var(--success-green);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Progress Bars Premium */
        .progress-bar-container { width: 100%; background: #e2e8f0; height: 8px; border-radius: 9999px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); width: 0%; position: relative; overflow: hidden; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        @media print {
            .sidebar { display: none; }
            .main-content { padding: 0; margin: 0; overflow: visible; }
            .view-section { display: none; }
            .view-section.active { display: block; }
            .btn-add-eq, .training-controls, .escala-actions { display: none; }
            .report-paper { box-shadow: none; border: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <h2 id="sb_brand" contenteditable="true" onblur="globalEditor.save(this)">BRIGADA HSM</h2>
            <span id="sb_sub" contenteditable="true" onblur="globalEditor.save(this)">Hospital Santa Marta</span>
        </div>
        <div class="user-profile">
            <!-- DICA: Clique 2x no avatar para trocar √≠cone, ou edite o nome para mudar iniciais -->
            <img src="https://ui-avatars.com/api/?name=Medeiros&background=dc2626&color=fff" alt="User" class="avatar icon-editable" ondblclick="iconPicker.open(this)" id="user_avatar_img">
            <div class="user-info">
                <h4 id="sb_user_name" contenteditable="true" onblur="globalEditor.save(this); globalEditor.updateAvatar(this.innerText)">Medeiros</h4>
                <p id="sb_user_role" contenteditable="true" onblur="globalEditor.save(this)">Chefe de Brigada</p>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="switchView('dashboard', this)">
                <i class="fa-solid fa-table-columns icon-editable" ondblclick="iconPicker.open(this)"></i> Dashboard
            </li>
            <li class="nav-item" onclick="switchView('indicadores', this)">
                <i class="fa-solid fa-chart-line icon-editable" ondblclick="iconPicker.open(this)"></i> Indicadores
            </li>
            <li class="nav-item" onclick="switchView('escala', this)">
                <i class="fa-solid fa-calendar-days icon-editable" ondblclick="iconPicker.open(this)"></i> Escala
            </li>
            <li class="nav-item" onclick="switchView('ferias', this)">
                <i class="fa-solid fa-plane-departure icon-editable" ondblclick="iconPicker.open(this)"></i> F√©rias
            </li>
            <li class="nav-item" onclick="switchView('treinamentos', this)">
                <i class="fas fa-graduation-cap icon-editable" ondblclick="iconPicker.open(this)"></i> Treinamentos
            </li>
            <li class="nav-item" onclick="switchView('equipamentos', this)">
                <i class="fas fa-fire-extinguisher icon-editable" ondblclick="iconPicker.open(this)"></i> Equipamentos
            </li>
            <li class="nav-item" onclick="switchView('normas', this)">
                <i class="fas fa-book icon-editable" ondblclick="iconPicker.open(this)"></i> Normas (NR)
            </li>
            <li class="nav-item" onclick="switchView('relatorios', this)">
                <i class="fas fa-file-contract icon-editable" ondblclick="iconPicker.open(this)"></i> Relat√≥rio 2025
            </li>
        </ul>
        <div class="logout"><i class="fa-solid fa-power-off"></i> Sair</div>
    </aside>

    <main class="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <header class="header">
                <div class="header-title">
                    <h1 id="dash_title" contenteditable="true" onblur="globalEditor.save(this)"><i class="fa-solid fa-grip icon-editable" ondblclick="iconPicker.open(this)"></i> Vis√£o Geral</h1>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="status-pill"><div class="status-dot"></div> <span id="dash_status" contenteditable="true" onblur="globalEditor.save(this)">HSM Operante</span></div>
                    <!-- DATA HEADER EDIT√ÅVEL -->
                    <div class="date-info" id="dashboardDate"></div>
                </div>
            </header>

            <div class="top-grid">
                <div class="card welcome-card">
                    <h2 id="dash_hero_title" contenteditable="true" onblur="globalEditor.save(this)">Ol√°, Chefe Medeiros</h2>
                    <p id="dash_hero_sub" contenteditable="true" onblur="globalEditor.save(this)">O sistema de escala e monitoramento est√° ativo e sincronizado.</p>
                </div>
                <div class="card">
                    <!-- EXTINTORES VENCENDO AGORA EDIT√ÅVEL -->
                    <div style="font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase;" contenteditable="true" id="label_ext_venc" onblur="globalEditor.save(this)">Extintores Vencendo</div>
                    <div class="metric-value" contenteditable="true" id="metric_ext_val" onblur="globalEditor.save(this)">3</div>
                    <div style="font-size: 12px; color: var(--warning-orange); font-weight: 600;" contenteditable="true" id="metric_local" onblur="globalEditor.save(this)">Setor UTI</div>
                    <i class="fa-solid fa-triangle-exclamation icon-editable" ondblclick="iconPicker.open(this)" style="position:absolute; top:20px; right:20px; color:var(--warning-orange);"></i>
                </div>
            </div>

            <div class="content-grid">
                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 15px; display:flex; gap:8px; align-items:center;">
                        <!-- √çCONE DI√ÅRIO EDIT√ÅVEL -->
                        <i class="fa-solid fa-clock-rotate-left icon-editable" ondblclick="iconPicker.open(this)" style="color: var(--primary-red);"></i> 
                        <span contenteditable="true" onblur="globalEditor.save(this)" id="dash_ocur_title">Di√°rio de Ocorr√™ncias</span>
                    </h3>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon icon-green"><i class="fa-solid fa-check"></i></div>
                        <div style="width:100%">
                            <h5 style="font-size:14px;" id="t_item1_title" contenteditable="true" onblur="globalEditor.save(this)">Vistoria Ala Pedi√°trica</h5>
                            <p style="font-size:12px; color:#64748b;" id="t_item1_desc" contenteditable="true" onblur="globalEditor.save(this)">Rotas desobstru√≠das.</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon icon-orange"><i class="fa-solid fa-bell"></i></div>
                        <div style="width:100%">
                            <h5 style="font-size:14px;" id="t_item2_title" contenteditable="true" onblur="globalEditor.save(this)">Alarme Cozinha</h5>
                            <p style="font-size:12px; color:#64748b;" id="t_item2_desc" contenteditable="true" onblur="globalEditor.save(this)">Falso positivo.</p>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-icon icon-blue"><i class="fa-solid fa-user-clock"></i></div>
                        <div style="width:100%">
                            <h5 style="font-size:14px;" contenteditable="true" id="t_item3_title" onblur="globalEditor.save(this)">Troca de Turno</h5>
                            <p style="font-size:12px; color:#64748b;" contenteditable="true" id="t_item3_desc" onblur="globalEditor.save(this)">Equipe da Noite assumindo.</p>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-icon icon-red"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div style="width:100%">
                            <h5 style="font-size:14px;" contenteditable="true" id="t_item4_title" onblur="globalEditor.save(this)">Obstru√ß√£o Hidrante 02</h5>
                            <p style="font-size:12px; color:#64748b;" contenteditable="true" id="t_item4_desc" onblur="globalEditor.save(this)">Corredor Sul. Resolvido.</p>
                        </div>
                    </div>

                    <div class="timeline-item">
                        <div class="timeline-icon icon-green"><i class="fa-solid fa-clipboard-check"></i></div>
                        <div style="width:100%">
                            <h5 style="font-size:14px;" contenteditable="true" id="t_item5_title" onblur="globalEditor.save(this)">Checklist Di√°rio</h5>
                            <p style="font-size:12px; color:#64748b;" contenteditable="true" id="t_item5_desc" onblur="globalEditor.save(this)">Todos os setores ok.</p>
                        </div>
                    </div>
                </div>

                <div class="team-card">
                    <h3 style="font-size: 16px;">Plant√£o Hoje</h3>
                    <span style="font-size: 11px; opacity:0.7;" id="shiftLabel">Carregando...</span>
                    <div class="team-list" id="teamListContainer"></div>
                    <button style="width:100%; margin-top:20px; background:#dc2626; color:white; border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer;" onclick="switchView('escala', document.querySelectorAll('.nav-item')[1])">Ver Escala Completa</button>
                </div>
            </div>
        </div>

        <!-- VIEW INDICADORES: Corrigida (sem classes invasivas) -->
        <div id="view-indicadores" class="view-section">
            <div id="app-header"></div>
            <!-- Container Interno com Flex para layout de altura total -->
            <div class="ind-container">
                <div class="max-w-[1600px] mx-auto p-6 space-y-6 w-full flex-1 overflow-y-auto">
                    <nav id="tab-navigation" class="flex border-b border-slate-200 gap-6 mb-6"></nav>
                    <main id="dashboard-content" class="min-h-[600px]"></main>
                </div>
            </div>
        </div>

        <div id="view-escala" class="view-section">
            <div class="escala-container">
                <div class="section-dark-header">
                    <div>
                        <h1 style="font-size: 1.1rem; display:flex; align-items:center; gap:10px;" id="esc_title" contenteditable="true" onblur="globalEditor.save(this)">GERENCIADOR DE ESCALA 2026 üî•</h1>
                        <span style="font-size: 0.8rem; color: #cbd5e1;" id="esc_sub" contenteditable="true" onblur="globalEditor.save(this)">Brigada de Inc√™ndio - Hospital Santa Marta</span>
                    </div>

                    <div class="month-control">
                        <button class="nav-arrow" onclick="escalaApp.changeMonth(-1)">‚ùÆ</button>
                        <div id="displayMonth">JANEIRO 2026</div>
                        <button class="nav-arrow" onclick="escalaApp.changeMonth(1)">‚ùØ</button>
                    </div>

                    <div class="escala-actions">
                        <button class="btn-reset" onclick="escalaApp.resetMonth()">‚Ü∫ Limpar M√™s</button>
                        <button onclick="window.print()">üñ® Imprimir</button>
                    </div>
                </div>

                <div class="table-paper">
                    <div class="table-scroll">
                        <table id="mainTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="footer-grid">
                    <div class="check-card">
                        <div class="card-title-purple" contenteditable="true" id="ft_t1" onblur="globalEditor.save(this)">Checklist Individual</div>
                        <div id="listCheck1" style="flex:1;"></div>
                        <div class="alert-box" contenteditable="true" id="ft_a1" onblur="globalEditor.save(this)">
                            <strong>Todos os brigadistas</strong> executam essa demanda.<br>Diariamente no Checklist e Livro.
                        </div>
                    </div>
                    <div class="check-card">
                        <div class="card-title-purple" contenteditable="true" id="ft_t2" onblur="globalEditor.save(this)">Escala de Extintores</div>
                        <div id="listCheck2" style="flex:1;"></div>
                        <div class="alert-box" contenteditable="true" id="ft_a2" onblur="globalEditor.save(this)">
                            <strong>Aten√ß√£o:</strong> Executar do dia 01/03 ao 16/03.<br>Total de 8 plant√µes.
                        </div>
                    </div>
                    <div class="check-card">
                        <div class="card-title-purple" contenteditable="true" id="ft_t3" onblur="globalEditor.save(this)">Obstru√ß√£o de Extintores e Hidrantes</div>
                        <div id="listCheck3" style="flex:1;"></div>
                        <div class="alert-box" contenteditable="true" id="ft_a3" onblur="globalEditor.save(this)">
                            <strong>Todos os brigadistas</strong> executam essa demanda.<br>Diariamente no Checklist e Livro.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-ferias" class="view-section" style="height: 100%;">
            <div class="soon-container">
                <i class="fa-solid fa-umbrella-beach soon-icon"></i>
                <h2 style="font-size: 2rem; color: #1e293b; margin-bottom: 10px;">EM BREVE</h2>
                <p>O m√≥dulo de gest√£o de f√©rias est√° em desenvolvimento.</p>
            </div>
        </div>

        <div id="view-treinamentos" class="view-section">
            <div class="section-dark-header">
                <div>
                    <h2 style="font-size: 1.1rem; display:flex; align-items:center; gap:10px;" id="train_main_title" contenteditable="true" onblur="globalEditor.save(this)">PLANO DE ENSINO 2026</h2>
                    <p style="font-size: 0.8rem; color: #cbd5e1; margin-top:4px;" id="train_main_sub" contenteditable="true" onblur="globalEditor.save(this)">Diretrizes de instru√ß√£o continuada.</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 50px; font-size: 0.9rem;">
                    <i class="far fa-calendar-alt" style="margin-right: 8px; color: #f97316;"></i> Exerc√≠cio 2026
                </div>
            </div>

            <div class="training-controls">
                <div class="training-filters">
                    <button class="filter-btn active" onclick="treinamentosApp.filter('todos', this)">
                        <i class="fas fa-layer-group"></i> Todos
                    </button>
                    <button class="filter-btn" onclick="treinamentosApp.filter('Lideran√ßa', this)">
                        <i class="fas fa-chess-king"></i> Chefia
                    </button>
                    <button class="filter-btn" onclick="treinamentosApp.filter('T√©cnico', this)">
                        <i class="fas fa-fire-extinguisher"></i> Operacional
                    </button>
                    <button class="filter-btn" onclick="treinamentosApp.filter('Comportamental', this)">
                        <i class="fas fa-user-shield"></i> Comportamental
                    </button>
                </div>

                <div class="training-progress-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <small style="opacity: 0.8; text-transform: uppercase; font-size: 0.7rem; font-weight: 700;">Progresso</small>
                        <span id="prog-percent" style="font-size: 0.8rem; font-weight:700;">0%</span>
                    </div>
                    <div class="progress-bar"><div class="fill" id="fill"></div></div>
                    <div style="text-align: right; margin-top: 5px; font-size: 0.75rem; opacity: 0.7;">
                        <span id="prog-text">0</span> de <span id="total-modules">10</span> M√≥dulos
                    </div>
                </div>
            </div>

            <div id="training-grid-container" class="module-list"></div>
        </div>

        <div id="view-equipamentos" class="view-section">
            <div class="section-dark-header">
                <h2>CONTROLE DE EQUIPAMENTOS</h2>
            </div>
            <div class="equip-grid-container">
                <div class="equip-box">
                    <div class="equip-box-header bg-ext">
                        <span><i class="fa-solid fa-fire-extinguisher"></i> Extintores</span>
                        <button class="btn-add-eq" onclick="equipApp.add('ext')">+ Add</button>
                    </div>
                    <table class="equip-table"><tbody id="tb-ext"></tbody></table>
                </div>
                <div class="equip-box">
                    <div class="equip-box-header bg-hid">
                        <span><i class="fa-solid fa-faucet"></i> Hidrantes</span>
                        <button class="btn-add-eq" onclick="equipApp.add('hid')">+ Add</button>
                    </div>
                    <table class="equip-table"><tbody id="tb-hid"></tbody></table>
                </div>
                <div class="equip-box">
                    <div class="equip-box-header bg-luz">
                        <span><i class="fa-regular fa-lightbulb"></i> Lumin√°rias</span>
                        <button class="btn-add-eq" onclick="equipApp.add('luz')">+ Add</button>
                    </div>
                    <table class="equip-table"><tbody id="tb-luz"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-normas" class="view-section">
            <div class="section-dark-header">
                <h2>BIBLIOTECA DE NORMAS (NRs)</h2>
            </div>
            <div class="normas-intro-box">
                <h3 style="color:#1e293b; margin-bottom:10px;" contenteditable="true">Introdu√ß√£o √†s Normas Regulamentadoras</h3>
                <p contenteditable="true" style="color:#64748b;">Abaixo listamos as principais NRs aplic√°veis ao ambiente hospitalar do HSM. Clique no item para expandir o resumo t√©cnico.</p>
            </div>
            <div id="normas-list-container"></div>
        </div>

        <div id="view-relatorios" class="view-section">
            <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                <button onclick="window.print()" style="background:var(--text-primary); color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer;">IMPRIMIR PDF</button>
            </div>
            
            <div class="report-paper">
                <div class="doc-header">
                    <img src="https://ui-avatars.com/api/?name=H+S+M&background=dc2626&color=fff&size=64" style="border-radius: 50%; margin-bottom: 10px;">
                    <h2 class="doc-title" contenteditable="true">RELAT√ìRIO CONSOLIDADO DE ATIVIDADES PRESTADAS</h2>
                    <div class="doc-subtitle" contenteditable="true">BRIGADA DE INC√äNDIO ‚Äì HOSPITAL SANTA MARTA</div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 5px; font-weight: bold;" contenteditable="true">PER√çODO: JANEIRO A NOVEMBRO DE 2025</div>
                </div>

                <div class="doc-section">
                    <div class="doc-h3">PANORAMA GERAL DOS 11 MESES</div>
                    <div class="doc-text" contenteditable="true">
De janeiro a novembro de 2025, a Brigada de Inc√™ndio do Hospital Santa Marta atendeu aproximadamente 110 emerg√™ncias, entre acidentes de trabalho, acidentes de trajeto, mal-estares, exposi√ß√µes a material biol√≥gico, princ√≠pios de inc√™ndio e resgates em elevadores.

Paralelamente, foram mantidas rotinas mensais de inspe√ß√£o em hidrantes, extintores, bombas de inc√™ndio, portas corta-fogo, lumin√°rias de emerg√™ncia e SPDA, al√©m de simulados e treinamentos voltados para evacua√ß√£o, primeiros socorros e atua√ß√£o em emerg√™ncias.

Ao longo do per√≠odo, a brigada enfrentou tr√™s desafios constantes: falhas recorrentes em elevadores (com destaque para os elevadores 10 e 4), obstru√ß√µes frequentes de extintores e hidrantes e problemas em sistemas de alarme, em especial a central do ISMEP com placas queimadas. Mesmo diante desses cen√°rios, a equipe manteve resposta r√°pida, refor√ßou treinamentos, integrou novos brigadistas e atuou em conformidade com a NT007/2011 do CBMDF, NR-23, ABNT NBR 14276 e diretrizes do PPCI.
                    </div>
                </div>

                <div class="doc-section">
                    <div class="doc-h3">DESTAQUES M√äS A M√äS</div>
                    <div class="doc-text" contenteditable="true">
Janeiro foi marcado por atendimentos de mal-estar, escoria√ß√µes, acidente de trajeto e pequenos traumas, ao mesmo tempo em que se iniciou a reorganiza√ß√£o da sala da brigada e a confer√™ncia geral de equipamentos.

Fevereiro a Outubro seguiram com rotinas intensas de preven√ß√£o, acompanhamento de obras e gest√£o de riscos em √°reas cr√≠ticas, conforme registrado nos checklists di√°rios e livros de ocorr√™ncia da brigada.
                    </div>
                </div>

                <div class="doc-section">
                    <div class="doc-h3">CONSIDERA√á√ïES FINAIS E 2026</div>
                    <div class="doc-text" contenteditable="true">
Os pontos mais sens√≠veis do per√≠odo est√£o claramente identificados: elevadores com falhas cr√¥nicas e per√≠odos prolongados de inoper√¢ncia, especialmente os elevadores 10 e 4; central de alarme do ISMEP com placas queimadas e trechos inoperantes; e obstru√ß√µes reincidentes de hidrantes e extintores em √°reas assistenciais e de apoio. Esses fatores impactam diretamente a seguran√ßa e a log√≠stica hospitalar, exigindo decis√µes mais estruturais, e n√£o apenas a√ß√µes corretivas pontuais.

Para os pr√≥ximos meses, as prioridades sugeridas s√£o: buscar solu√ß√£o definitiva para os elevadores mais problem√°ticos, com avalia√ß√£o t√©cnica profunda e eventual substitui√ß√£o de componentes cr√≠ticos; concluir com urg√™ncia a recupera√ß√£o da central de alarme do ISMEP; intensificar a instala√ß√£o de sinaliza√ß√µes faltantes; tratar o tema das obstru√ß√µes de forma mais firme, combinando orienta√ß√£o, di√°logo de seguran√ßa e responsabiliza√ß√£o por setor; e manter o ritmo de simulados e treinamentos, em especial com os novos brigadistas.

De forma geral, o per√≠odo de janeiro a novembro de 2025 mostra uma brigada madura, presente em todas as frentes de seguran√ßa do hospital, atuando tanto no combate e resposta √†s emerg√™ncias quanto na preven√ß√£o, educa√ß√£o e apoio √†s demais √°reas. Isso cria uma base consistente para avan√ßar em 2026 com foco em resolver os gargalos estruturais e consolidar ainda mais a cultura de seguran√ßa no Hospital Santa Marta.
                    </div>
                </div>

                <div style="margin-top: 80px; display: flex; justify-content: space-around;">
                    <div style="text-align: center; border-top: 1px solid #1e293b; padding-top: 10px; width: 40%;">
                        <div contenteditable="true" style="font-weight: 700;">Medeiros</div>
                        <div style="font-size: 0.8rem;">Chefe de Brigada</div>
                    </div>
                    <div style="text-align: center; border-top: 1px solid #1e293b; padding-top: 10px; width: 40%;">
                        <div contenteditable="true" style="font-weight: 700;">Diretoria T√©cnica</div>
                        <div style="font-size: 0.8rem;">Visto / Aprova√ß√£o</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="modal-overlay" id="iconModal" onclick="iconPicker.close(event)">
        <div class="picker-box" onclick="event.stopPropagation()">
            <h3 style="margin-bottom: 10px; color: var(--text-primary);">Escolher √çcone</h3>
            <div class="icon-grid" id="pickerGrid"></div>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ÉO GERAL ===
        const CONFIG = {
            year: 2026,
            months: ["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"],
            weekDays: ["D","S","T","Q","Q","S","S"],
            status: [
                { code: 0, label: "SD",      class: "st-sd"      },
                { code: 1, label: "SN",      class: "st-sn"      },
                { code: 2, label: "F",       class: "st-f"       },
                { code: 3, label: "F√âRIAS",  class: "st-ferias"  },
                { code: 4, label: "FS",      class: "st-fs"      }
            ]
        };

        const DEFAULT_DATA = {
            day: [
                { name: "JOSIVALDO ROG√âRIO",   id: "4360", ptr: [0,2,0,2,0,2] },
                { name: "JOEL CARNEIRO",       id: "8187", ptr: [3,3,3,3,3,3] },
                { name: "ELLEN MARCIELI",      id: "9268", ptr: [2,0,2,0,2,0] },
                { name: "AGMAR HENRIQUE",      id: "2483", ptr: [0,2,0,2,0,2] },
                { name: "ANTONIETA MARIA",     id: "9267", ptr: [0,2,4,2,0,2] }
            ],
            night: [
                { name: "DANILO ROCHA",        id: "9252", ptr: [2,1,2,4] },
                { name: "ROSA APARECIDA",      id: "0971", ptr: [1,2,1,2] },
                { name: "PETERSON PEVIDOR",    id: "7189", ptr: [1,2,1,2] },
                { name: "JULLYANDERSON RIBEIRO",id: "9351", ptr: [1,2,4,2] }
            ]
        };

        // === EDITOR GLOBAL ===
        const globalEditor = {
            data: {},
            init() {
                const saved = localStorage.getItem('hsm_global_edits');
                if (saved) {
                    this.data = JSON.parse(saved);
                    Object.keys(this.data).forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.innerText = this.data[id];
                    });
                }
            },
            save(element) {
                if(!element.id) return;
                this.data[element.id] = element.innerText;
                localStorage.setItem('hsm_global_edits', JSON.stringify(this.data));
            },
            updateAvatar(newName) {
                const avatar = document.getElementById('user_avatar_img');
                if(avatar) {
                    avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=dc2626&color=fff`;
                }
            }
        };

        // === ICON PICKER ===
        const iconPicker = {
            currentEl: null,
            icons: ["fa-fire", "fa-fire-extinguisher", "fa-user-shield", "fa-kit-medical", "fa-house-medical", "fa-triangle-exclamation", "fa-check", "fa-xmark", "fa-clipboard-check", "fa-calendar-days", "fa-graduation-cap", "fa-book", "fa-helmet-safety", "fa-walkie-talkie", "fa-bell", "fa-file-signature", "fa-print", "fa-gear", "fa-chart-pie", "fa-hospital", "fa-plane-departure", "fa-file-contract"],
            init() {
                const grid = document.getElementById('pickerGrid');
                this.icons.forEach(cls => {
                    const div = document.createElement('div');
                    div.className = 'icon-opt';
                    div.innerHTML = `<i class="fa-solid ${cls}"></i>`;
                    div.onclick = () => this.pick(cls);
                    grid.appendChild(div);
                });
            },
            open(el) {
                this.currentEl = el;
                document.getElementById('iconModal').classList.add('open');
            },
            close(e) {
                if(e.target.id === 'iconModal') document.getElementById('iconModal').classList.remove('open');
            },
            pick(cls) {
                if(this.currentEl) {
                    if(this.currentEl.tagName === 'IMG') {
                        const newIcon = document.createElement('i');
                        newIcon.className = `fa-solid ${cls} icon-editable avatar`;
                        newIcon.style.display = 'flex';
                        newIcon.style.alignItems = 'center';
                        newIcon.style.justifyContent = 'center';
                        newIcon.style.fontSize = '20px';
                        newIcon.ondblclick = function() { iconPicker.open(this); };
                        this.currentEl.parentNode.replaceChild(newIcon, this.currentEl);
                    } else {
                        this.currentEl.className = `fa-solid ${cls} icon-editable`;
                    }
                }
                document.getElementById('iconModal').classList.remove('open');
            }
        };

        // === NAVEGA√á√ÉO ===
        function switchView(viewName, element) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            if(element) {
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
            if(viewName === 'escala') escalaApp.init();
            if(viewName === 'treinamentos') treinamentosApp.init();
            if(viewName === 'equipamentos') equipApp.init();
            if(viewName === 'normas') normasApp.init();
            if(viewName === 'dashboard') initDashboard();
            if(viewName === 'indicadores') {
                if (window.initIndicadoresSystem) window.initIndicadoresSystem();
            }
        }

        // === DASHBOARD LOGIC (CORRIGIDA) ===
        function initDashboard() {
            const now = new Date();
            const d = now.getDate();
            const m = now.getMonth();
            const weekNames = ["DOM", "SEG", "TER", "QUA", "QUI", "SEX", "S√ÅB"];
            
            const savedHeader = localStorage.getItem('hsm_global_edits') ? JSON.parse(localStorage.getItem('hsm_global_edits'))['header_hsm_text'] : null;
            const headerText = savedHeader || "HOSPITAL SANTA MARTA";

            document.getElementById('dashboardDate').innerHTML = `<span id="header_hsm_text" contenteditable="true" onblur="globalEditor.save(this)">${headerText}</span><br><span style="color:#1e293b; font-size:14px;">${weekNames[now.getDay()]}, ${d} DE ${CONFIG.months[m].substring(0,3)}</span>`;
            document.getElementById('shiftLabel').innerText = `Escala ativa para ${d}/${m+1}/${CONFIG.year}`;

            const active = [];
            
            let teamsSource = JSON.parse(localStorage.getItem('hsm_final_system_v1'));
            
            if (!teamsSource) {
                teamsSource = JSON.parse(JSON.stringify(DEFAULT_DATA));
            }

            const check = (list, role) => {
                list.forEach(p => {
                    let st = 2;
                    if(p.ptr && p.ptr.length >= 28) {
                         st = p.ptr[d - 1] !== undefined ? p.ptr[d - 1] : 2;
                    } 
                    else if(p.ptr) {
                         st = p.ptr[(d - 1) % p.ptr.length];
                    }

                    if(st === 0 || st === 1) { 
                        active.push({n: p.name, r: role, st: st});
                    }
                });
            };

            if(teamsSource.day) check(teamsSource.day, "Brigadista (Dia)");
            if(teamsSource.night) check(teamsSource.night, "Brigadista (Noite)");

            const container = document.getElementById('teamListContainer');
            if(container) {
                container.innerHTML = "";
                if(active.length === 0) {
                    container.innerHTML = "<div style='text-align:center; font-size:12px; opacity:0.7; padding:10px;'>Ningu√©m escalado hoje (Folga Geral).</div>";
                } else {
                    active.forEach(p => {
                        const initials = p.n.split(" ").map(n=>n[0]).join("").substring(0,2);
                        container.innerHTML += `
                            <div class="team-member" style="border-left: 3px solid ${p.st===0 ? '#10b981' : '#3b82f6'}">
                                <img src="https://ui-avatars.com/api/?name=${initials}&background=random&color=fff" alt="${p.n}">
                                <div style="line-height:1.2;">
                                    <h6 style="font-size:13px; font-weight:600;">${p.n.split(" ")[0] + " " + (p.n.split(" ")[1] || "")}</h6>
                                    <span style="font-size:10px; opacity:0.7;">${p.r}</span>
                                </div>
                            </div>
                        `;
                    });
                }
            }
        }

        // === ESCALA APP ===
        const escalaApp = {
            currentMonth: 0,
            teams: {}, 

            init() {
                const now = new Date();
                if(now.getFullYear() === CONFIG.year) this.currentMonth = now.getMonth();
                
                const saved = localStorage.getItem('hsm_final_system_v1');
                if (saved) {
                    this.teams = JSON.parse(saved);
                } else {
                    this.teams = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    this.expandPatterns(this.teams.day);
                    this.expandPatterns(this.teams.night);
                    this.saveData(); 
                }
                
                this.render();
                initDashboard(); 
            },

            expandPatterns(teamList) {
                teamList.forEach(member => {
                    if (member.ptr.length < 32) {
                        const newPtr = [];
                        for (let i = 0; i < 32; i++) {
                            newPtr.push(member.ptr[i % member.ptr.length]);
                        }
                        member.ptr = newPtr;
                    }
                });
            },

            saveData() {
                localStorage.setItem('hsm_final_system_v1', JSON.stringify(this.teams));
                initDashboard(); 
            },

            toggle(type, memberIdx, dayIdx) {
                const currentCode = this.teams[type][memberIdx].ptr[dayIdx];
                this.teams[type][memberIdx].ptr[dayIdx] = (currentCode + 1) % 5;
                this.saveData(); 
                this.render(); 
            },

            updateName(type, memberIdx, newName) {
                this.teams[type][memberIdx].name = newName;
                this.saveData();
            },

            render() {
                const m = this.currentMonth;
                const daysTotal = new Date(CONFIG.year, m + 1, 0).getDate();
                const startDay = new Date(CONFIG.year, m, 1).getDay();

                document.getElementById('displayMonth').innerText = `${CONFIG.months[m]} ${CONFIG.year}`;
                let htmlHead = `<tr class="th-days"><th colspan="2" style="text-align:left; padding-left:15px;">BRIGADA DE INC√äNDIO</th>`;
                for(let i=1; i<=daysTotal; i++) htmlHead += `<th>${i}</th>`;
                htmlHead += `</tr><tr class="th-week"><th class="col-sticky">NOME</th><th class="col-id">MATR.</th>`;
                
                let wd = startDay;
                for(let i=1; i<=daysTotal; i++) {
                    const isWeekend = (wd===0 || wd===6);
                    htmlHead += `<th class="${isWeekend ? 'weekend-th' : ''}">${CONFIG.weekDays[wd]}</th>`;
                    wd = (wd+1)%7;
                }
                htmlHead += `</tr>`;
                document.getElementById('tableHead').innerHTML = htmlHead;

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = "";

                const createRow = (person, type, pIdx) => {
                    let html = `<tr>
                        <td class="col-sticky" contenteditable="true" onblur="escalaApp.updateName('${type}', ${pIdx}, this.innerText)">${person.name}</td>
                        <td class="col-id">${person.id}</td>`;
                    
                    let currentWd = startDay;
                    for(let i=0; i<daysTotal; i++) {
                        const code = person.ptr[i] !== undefined ? person.ptr[i] : 2;
                        const st = CONFIG.status.find(s => s.code === code) || CONFIG.status[2];
                        const isWeekend = (currentWd===0 || currentWd===6);
                        html += `<td class="cell-status ${st.class} ${isWeekend && code !== 3 ? 'weekend-col' : ''}"
                                     onclick="escalaApp.toggle('${type}', ${pIdx}, ${i})">
                                     ${st.label}
                                 </td>`;
                        currentWd = (currentWd+1)%7;
                    }
                    html += "</tr>";
                    return html;
                };

                tbody.innerHTML += `<tr><td colspan="${daysTotal+2}" class="section-header-row">EQUIPE DIURNA (DIA)</td></tr>`;
                this.teams.day.forEach((p, i) => tbody.innerHTML += createRow(p, 'day', i));
                
                tbody.innerHTML += `<tr><td colspan="${daysTotal+2}" class="section-header-row">EQUIPE NOTURNA (NOITE)</td></tr>`;
                this.teams.night.forEach((p, i) => tbody.innerHTML += createRow(p, 'night', i));

                this.renderFooter();
            },

            renderFooter() {
                const tasksDefault = ["Hidrantes de Parede","Bombas de Inc√™ndio","Portas de Emerg√™ncia","Aterramento e SPDA","Portas de Emerg√™ncia","Hidrantes de Parede","Aterramento e SPDA","Lumin√°rias de Emerg√™ncia","Bombas de Inc√™ndio"];
                const allStaff = [...this.teams.day, ...this.teams.night];
                
                const createList = (listId, withTask) => {
                    const container = document.getElementById(listId);
                    container.innerHTML = allStaff.map((p, i) => `
                        <div class="task-row">
                            <span class="task-name">${p.name}</span>
                            <span class="task-desc" contenteditable="true" id="${listId}_t_${p.id}" onblur="globalEditor.save(this)">${withTask ? (tasksDefault[i] || "") : ""}</span>
                        </div>
                    `).join("");
                };
                createList("listCheck1", true);
                createList("listCheck2", false);
                createList("listCheck3", false);
                globalEditor.init();
            },
            changeMonth(dir) {
                const next = this.currentMonth + dir;
                if(next >= 0 && next <= 11) {
                    this.currentMonth = next;
                    this.render();
                }
            },
            resetMonth() { 
                if(confirm("ATEN√á√ÉO: Isso vai apagar todas as edi√ß√µes e restaurar o padr√£o. Confirmar?")) {
                    localStorage.removeItem('hsm_final_system_v1'); // Limpa a chave certa
                    location.reload();
                }
            }
        };

        // === TREINAMENTOS APP ===
        const treinamentosApp = {
            modules: [
                { id: 1, title: "Compet√™ncias Essenciais", subtitle: "Fundamentos e Postura Padr√£o", category: "Comportamental", type: "comp", theory: ["Al√ßa Fechada (Closed Loop): Protocolo obrigat√≥rio.", "O Saca-Rolha: 1. EPI ok? 2. Cena segura? 3. R√°dio funciona?", "Disciplina Sonora: R√°dio √© para comunica√ß√£o t√°tica curta."], drill: "Exerc√≠cio 'Cego': Aluno de costas recebe 3 ordens via r√°dio com ru√≠do de fundo.", mistakes: "Correr sem r√°dio; Gritar ordens sobrepostas.", key: "Na d√∫vida, n√£o corra. Pare, respire, pense, aja." },
                { id: 2, title: "Lideran√ßa Situacional", subtitle: "Comando Inicial de Crise", category: "Lideran√ßa", type: "lid", theory: ["Comando do Primeiro: O primeiro na cena √â o comandante.", "M√©todo START: Triagem r√°pida de decis√£o.", "Delega√ß√£o Direta: Aponte e fale: 'VOC√ä, pegue o extintor'."], drill: "Simula√ß√£o 'Est√°tua': L√≠der PARADO no centro dando ordens.", mistakes: "L√≠der tentar apagar o fogo sozinho.", key: "Quem faz a tarefa operacional, n√£o comanda a cena." },
                { id: 101, title: "Casa de Bombas", subtitle: "Opera√ß√£o de Sistema Hidr√°ulico", category: "T√©cnico", type: "tec", theory: ["Funcionamento das bombas Jockey e Principal.", "Teste de vaz√£o e estanqueidade.", "Manobra de registros de gaveta."], drill: "Simula√ß√£o de partida manual da bomba.", mistakes: "Fechar registro de suc√ß√£o com bomba ligada.", key: "√Ågua pressurizada n√£o perdoa erro." },
                { id: 102, title: "Classes de Inc√™ndio", subtitle: "Identifica√ß√£o e Agentes", category: "T√©cnico", type: "tec", theory: ["Classe A: S√≥lidos (√°gua).", "Classe B: L√≠quidos (P√≥/CO2).", "Classe C: El√©tricos (CO2/P√≥).", "Classe K: Cozinhas (Acetato)."], drill: "Quiz r√°pido de sele√ß√£o de extintor.", mistakes: "Jogar √°gua em quadro el√©trico.", key: "Escolha o agente antes de atacar." },
                { id: 103, title: "N√≥s e Amarra√ß√µes", subtitle: "Salvamento e Equipamentos", category: "T√©cnico", type: "tec", theory: ["N√≥ Direito: Uni√£o de cabos iguais.", "Lais de Guia: Al√ßa que n√£o corre.", "N√≥ Fiel: Ancoragem r√°pida."], drill: "Execu√ß√£o de n√≥s vendado.", mistakes: "N√≥ frouxo ou 'cego'.", key: "Um n√≥ mal feito custa uma vida." },
                { id: 104, title: "Riscos Ocupacionais", subtitle: "Seguran√ßa do Trabalho", category: "Seguran√ßa", type: "seg", theory: ["F√≠sicos: Ru√≠do, calor.", "Qu√≠micos: Vapores, poeiras.", "Biol√≥gicos: V√≠rus, bact√©rias."], drill: "Identifica√ß√£o de riscos no ambiente.", mistakes: "Ignorar EPI para riscos invis√≠veis.", key: "Seguran√ßa √© h√°bito, n√£o ato." }
            ],
            completed: [],

            init() {
                this.completed = JSON.parse(localStorage.getItem('hsm_2026_data')) || [];
                this.renderContent(this.modules);
                this.updateProgress();
            },

            toggleCard(id) {
                const card = document.getElementById(`card-${id}`);
                if(card) card.classList.toggle('active');
            },

            toggleStatus(e, id) {
                e.stopPropagation(); 
                const index = this.completed.indexOf(id);
                if (index > -1) this.completed.splice(index, 1);
                else this.completed.push(id);
                localStorage.setItem('hsm_2026_data', JSON.stringify(this.completed));
                this.renderContent(this.modules);
                this.updateProgress();
            },

            filter(cat, btnElement) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
                const container = document.getElementById('training-grid-container');
                container.style.opacity = '0';
                setTimeout(() => {
                    if (cat === 'todos') this.renderContent(this.modules);
                    else this.renderContent(this.modules.filter(m => m.category.includes(cat)));
                    container.style.opacity = '1';
                }, 200);
            },

            updateProgress() {
                const count = this.completed.length;
                const total = this.modules.length;
                const pct = Math.round((count/total)*100);
                document.getElementById('prog-text').innerText = count;
                document.getElementById('prog-percent').innerText = `${pct}%`;
                document.getElementById('fill').style.width = `${pct}%`;
            },

            renderContent(data) {
                const container = document.getElementById('training-grid-container');
                container.innerHTML = '';
                data.forEach(m => {
                    const isDone = this.completed.includes(m.id);
                    let badgeClass = m.type;
                    const html = `
                        <div class="module-card ${isDone ? 'done-border' : ''}" id="card-${m.id}">
                            <div class="card-header" onclick="treinamentosApp.toggleCard(${m.id})">
                                <div class="header-left">
                                    <div class="status-dot-t ${isDone ? 'done' : ''}"><i class="fas fa-check"></i></div>
                                    <div class="module-title">
                                        <h3 contenteditable="true" id="mod_${m.id}_title" onblur="globalEditor.save(this)">${m.title}</h3>
                                        <span contenteditable="true" id="mod_${m.id}_sub" onblur="globalEditor.save(this)">${m.subtitle}</span>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:15px;">
                                    <span class="badge ${badgeClass}">${m.category}</span>
                                    <i class="fas fa-chevron-down expand-icon"></i>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="content-wrapper">
                                    <div>
                                        <h4 class="training-h4"><i class="fas fa-book-open"></i> Pilares Te√≥ricos</h4>
                                        <ul class="theory-block">
                                            ${m.theory.map((t, idx) => `<li><span contenteditable="true" id="mod_${m.id}_theo_${idx}" onblur="globalEditor.save(this)">${t}</span></li>`).join('')}
                                        </ul>
                                        <div class="mistake-alert">
                                            <i class="fas fa-exclamation-triangle" style="margin-top:2px;"></i>
                                            <div>
                                                <strong>Erros para Corrigir:</strong><br>
                                                <span contenteditable="true" id="mod_${m.id}_mistake" onblur="globalEditor.save(this)">${m.mistakes}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="drill-box">
                                            <h4 class="training-h4"><i class="fas fa-stopwatch"></i> Din√¢mica Pr√°tica</h4>
                                            <strong contenteditable="true" id="mod_${m.id}_drill" onblur="globalEditor.save(this)">"${m.drill}"</strong>
                                            <p style="margin-top:10px;" contenteditable="true" id="mod_${m.id}_key" onblur="globalEditor.save(this)">"${m.key}"</p>
                                        </div>
                                        <button class="action-btn ${isDone ? 'completed' : ''}" onclick="treinamentosApp.toggleStatus(event, ${m.id})">
                                            <i class="fas ${isDone ? 'fa-check-circle' : 'fa-circle'}"></i>
                                            ${isDone ? 'M√≥dulo Conclu√≠do' : 'Marcar como Conclu√≠do'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
                globalEditor.init();
            }
        };

        // === EQUIPAMENTOS APP ===
        const equipApp = {
            data: [],
            init() {
                const stored = localStorage.getItem('hsm_equips');
                if(stored) this.data = JSON.parse(stored);
                else this.data = [
                    {cat:'ext', id:'EXT-01', loc:'Recep√ß√£o', val:'2026-05'},
                    {cat:'hid', id:'HID-A', loc:'Corredor A', val:'2030-01'},
                    {cat:'luz', id:'LUZ-05', loc:'Escada B', val:'-'}
                ];
                this.render();
            },
            add(cat) {
                this.data.push({cat:cat, id:'NOVO', loc:'Local', val:'Validade'});
                this.save();
            },
            save() {
                localStorage.setItem('hsm_equips', JSON.stringify(this.data));
                this.render();
            },
            del(idx) {
                if(confirm('Apagar item?')) { this.data.splice(idx,1); this.save(); }
            },
            update(originalIdx, key, val) {
                this.data[originalIdx][key] = val;
                this.save();
            },
            render() {
                const renderCat = (cat, elId) => {
                    const items = this.data.map((item, i) => ({...item, oIdx: i})).filter(i => i.cat === cat);
                    document.getElementById(elId).innerHTML = items.map(i => `
                        <tr>
                            <td contenteditable="true" onblur="equipApp.update(${i.oIdx}, 'id', this.innerText)" style="font-weight:700;">${i.id}</td>
                            <td contenteditable="true" onblur="equipApp.update(${i.oIdx}, 'loc', this.innerText)">${i.loc}</td>
                            <td contenteditable="true" onblur="equipApp.update(${i.oIdx}, 'val', this.innerText)">${i.val}</td>
                            <td style="width:30px; text-align:center;"><i class="fa-solid fa-trash" style="color:#ef4444; cursor:pointer;" onclick="equipApp.del(${i.oIdx})"></i></td>
                        </tr>
                    `).join('');
                };
                renderCat('ext', 'tb-ext');
                renderCat('hid', 'tb-hid');
                renderCat('luz', 'tb-luz');
            }
        };

        // === NORMAS APP ===
        const normasApp = {
            list: [
                {t:"NR 01 - Disposi√ß√µes Gerais", d:"Estabelece o campo de aplica√ß√£o e termos comuns a todas as NRs."},
                {t:"NR 05 - CIPA", d:"Comiss√£o Interna de Preven√ß√£o de Acidentes."},
                {t:"NR 06 - EPIs", d:"Equipamentos de Prote√ß√£o Individual: Requisitos para fornecimento e uso."},
                {t:"NR 23 - Prote√ß√£o Contra Inc√™ndios", d:"Determina medidas de preven√ß√£o e combate a inc√™ndios nos ambientes de trabalho."},
                {t:"NR 32 - Servi√ßos de Sa√∫de", d:"Seguran√ßa e Sa√∫de no Trabalho em Servi√ßos de Sa√∫de."}
            ],
            init() {
                document.getElementById('normas-list-container').innerHTML = this.list.map((n, i) => `
                    <div>
                        <div class="normas-menu-item" onclick="this.classList.toggle('active'); this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">
                            <strong>${n.t}</strong> <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="normas-content-box">
                            <p>${n.d}</p>
                            <br>
                            <a href="#" style="color:var(--info-blue); font-size:0.8rem;">Ver norma completa</a>
                        </div>
                    </div>
                `).join('');
            }
        };

        /* ==========================================================================
           L√ìGICA DO NOVO DASHBOARD DE INDICADORES
           (Integrada e Namespaceada para evitar conflitos)
           ========================================================================== */

        // 1. BANCO DE DADOS
        var DATABASE = {
            '2025': {
                conformidade: { labels: ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], values: [95.9, 82.9, 69.7, 80.0, 97.1, 96.3] },
                obstrucoes: { extintores: [10, 7, 6, 1, 12, 5], hidrantes: [10, 4, 3, 5, 8, 3] },
                evacuacao: { labels: ['Fev', 'Abr', 'Mai', 'Jul', 'Set', 'Nov'], tempos: [361, 194, 188, 199, 192, 185], populacao: [22, 30, 11, 10, 15, 18] },
                execucaoMensal: {
                    'Jul': { extintores: 100, hidrantes: 100, luminarias: 75, aterramento: 100, bombas: 100, portasCF: 100, livroOcorrencia: 96 },
                    'Ago': { extintores: 98, hidrantes: 68, luminarias: 52, aterramento: 100, bombas: 100, portasCF: 86, livroOcorrencia: 76 },
                    'Set': { extintores: 73, hidrantes: 100, luminarias: 39, aterramento: 0, bombas: 93, portasCF: 100, livroOcorrencia: 83 },
                    'Out': { extintores: 98, hidrantes: 65, luminarias: 100, aterramento: 100, bombas: 100, portasCF: 0, livroOcorrencia: 97 },
                    'Nov': { extintores: 98, hidrantes: 100, luminarias: 96, aterramento: 100, bombas: 96, portasCF: 100, livroOcorrencia: 90 },
                    'Dez': { extintores: 100, hidrantes: 98, luminarias: 95, aterramento: 100, bombas: 100, portasCF: 100, livroOcorrencia: 94 }
                },
                brigada: { totalInscritos: 109, totalTreinados: 55, turmas: [{ mes: 'Mar√ßo', inscritos: 39, treinados: 27, validade: '01/03/26' }, { mes: 'Junho', inscritos: 21, treinados: 8, validade: '01/07/26' }, { mes: 'Setembro', inscritos: 49, treinados: 20, validade: '01/09/26' }] },
                insights: {
                    'jul': ['In√≠cio do monitoramento sistem√°tico.', 'Performance excelente: 100% em Extintores e Hidrantes.', '20 obstru√ß√µes detectadas (10 ext. + 10 hid.).'],
                    'ago': ['Queda significativa em Lumin√°rias (52%).', 'Obstru√ß√µes reduziram 45% (20 ‚Üí 11).', 'Portas CF necessitam aten√ß√£o (86%).'],
                    'set': ['CR√çTICO: Aterramento em 0% - Falha grave.', 'Melhor tempo de evacua√ß√£o: 03:12.', 'Hidrantes em 100% de conformidade.'],
                    'out': ['CR√çTICO: Portas Corta-Fogo em 0%.', 'Recorde hist√≥rico: apenas 6 obstru√ß√µes.', 'Lumin√°rias recuperadas (100%).'],
                    'nov': ['Recupera√ß√£o total: 97.1% de conformidade m√©dia.', 'Aumento s√∫bito em obstru√ß√µes (+14 itens).', 'Todos os sistemas operacionais exceto Livro de Ocorr√™ncias (90%).'],
                    'dez': ['Encerramento do ano com 96.3% de conformidade.', 'Apenas 8 obstru√ß√µes no m√™s.', 'Todos os sistemas acima de 94%.'],
                    'all': ['Varia√ß√£o significativa: 69.7% (Set) a 97.1% (Nov).', 'Total de 66 obstru√ß√µes no per√≠odo Jul-Dez.', 'Tend√™ncia positiva de recupera√ß√£o.', 'Brigada: 55 treinados de 109 inscritos (50.5%).']
                }
            },
            '2026': {
                conformidade: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], values: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
                obstrucoes: { extintores: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], hidrantes: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
                evacuacao: { labels: [], tempos: [], populacao: [] },
                execucaoMensal: { 'Jan': { extintores: 0, hidrantes: 0, luminarias: 0, aterramento: 0, bombas: 0, portasCF: 0, livroOcorrencia: 0 } },
                brigada: { totalInscritos: 0, totalTreinados: 0, turmas: [] },
                insights: { 'all': ['Ano de 2026 - Dados em constru√ß√£o.'] }
            }
        };

        var MESES = {
            '2025': { labels: ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], fullNames: ['Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'], mapping: { 'jul': 0, 'ago': 1, 'set': 2, 'out': 3, 'nov': 4, 'dez': 5 } },
            '2026': { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], fullNames: ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'], mapping: { 'jan': 0, 'fev': 1 } }
        };

        var REFERENCIAS = { extintores: 201, hidrantes: 60, luminarias: 28, aterramento: 1, bombas: 7, portasCF: 14, livroOcorrencia: 12 };
        var METAS = { conformidade: { excelente: 95, bom: 85, regular: 75, critico: 75 }, tempoEvacuacao: { meta: 180, maximo: 420 } };
        var COLORS = { chart: { conformidade: '#2563eb', extintores: '#ef4444', hidrantes: '#3b82f6', luminarias: '#f59e0b', evacuacao: '#10b981' } };

        function getMonthData(year, month) {
            year = year || '2025'; month = month || 'all';
            var yearData = DATABASE[year];
            if (!yearData) return null;
            var monthIndex = MESES[year].mapping[month];
            if (month === 'all' || monthIndex === undefined) {
                var lastIndex = yearData.conformidade.values.length - 1;
                var lastLabel = yearData.conformidade.labels[lastIndex];
                return { conformidade: yearData.conformidade.values[lastIndex], totalObstrucoes: yearData.obstrucoes.extintores[lastIndex] + yearData.obstrucoes.hidrantes[lastIndex], insights: yearData.insights.all, execucao: yearData.execucaoMensal[lastLabel] || {} };
            }
            var mesLabel = yearData.conformidade.labels[monthIndex];
            return { conformidade: yearData.conformidade.values[monthIndex], totalObstrucoes: yearData.obstrucoes.extintores[monthIndex] + yearData.obstrucoes.hidrantes[monthIndex], insights: yearData.insights[month], execucao: yearData.execucaoMensal[mesLabel] || {} };
        }

        // 2. HELPERS
        function formatTime(seconds) { var mins = Math.floor(seconds / 60); var secs = seconds % 60; return String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0'); }
        function animateValue(elementId, newValue) { var element = document.getElementById(elementId); if (!element) return; element.style.opacity = '0'; element.style.transform = 'translateY(-10px)'; element.style.transition = 'all 0.3s ease'; setTimeout(function() { element.textContent = newValue; element.style.opacity = '1'; element.style.transform = 'translateY(0)'; }, 150); }

        // 3. CHART MANAGER
        var ChartManager = {
            instances: {},
            init: function() { Chart.defaults.font.family = "'Inter', sans-serif"; Chart.defaults.color = '#64748b'; Chart.defaults.plugins.legend.display = false; },
            createConformidade: function(canvasId, labels, data) {
                var canvas = document.getElementById(canvasId); if (!canvas) return;
                var ctx = canvas.getContext('2d');
                if (this.instances[canvasId]) this.instances[canvasId].destroy();
                var gradient = ctx.createLinearGradient(0, 0, 0, 350); gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)'); gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
                this.instances[canvasId] = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Conformidade (%)', data: data, borderColor: COLORS.chart.conformidade, backgroundColor: gradient, borderWidth: 4, fill: true, tension: 0.4, pointRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 60, max: 105 } } } });
            },
            createObstrucoes: function(canvasId, labels, extData, hidData) {
                var canvas = document.getElementById(canvasId); if (!canvas) return;
                if (this.instances[canvasId]) this.instances[canvasId].destroy();
                this.instances[canvasId] = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Extintores', data: extData, backgroundColor: COLORS.chart.extintores }, { label: 'Hidrantes', data: hidData, backgroundColor: COLORS.chart.hidrantes }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom' } } } });
            },
            createEvacuacao: function(canvasId, labels, data) {
                var canvas = document.getElementById(canvasId); if (!canvas) return;
                if (this.instances[canvasId]) this.instances[canvasId].destroy();
                var dataInMinutes = data.map(d => parseFloat((d / 60).toFixed(2)));
                this.instances[canvasId] = new Chart(canvas.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{ label: 'Tempo (min)', data: dataInMinutes, borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { annotation: { annotations: { metaLine: { type: 'line', yMin: 3.0, yMax: 3.0, borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5], label: { display: true, content: 'Meta 3:00', backgroundColor: '#10b981', color: 'white' } } } } } } });
            },
            update: function(canvasId, labels, data) {
                var chart = this.instances[canvasId]; if (!chart) return;
                chart.data.labels = labels;
                if (canvasId === 'obstructionsChart') { chart.data.datasets[0].data = data.ext; chart.data.datasets[1].data = data.hid; } else { chart.data.datasets[0].data = data; }
                chart.update();
            }
        };

        // 4. COMPONENTES
        var Components = {
            renderHeader: function() {
                var header = document.getElementById('app-header');
                header.innerHTML = '<div class="max-w-[1600px] mx-auto px-6 h-20 flex items-center justify-between"><div class="flex items-center gap-4"><div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-2.5 rounded-xl shadow-lg"><i class="ph-fill ph-fire text-2xl"></i></div><div><h1 class="text-lg font-bold text-slate-800 leading-tight">Dashboard Brigada H.S.M.</h1><div class="flex items-center gap-2 text-xs text-slate-500 font-medium"><span class="pulse-dot"></span><span>Indicadores de Seguran√ßa</span></div></div></div><div class="hidden md:flex items-center gap-4"><div class="flex items-center bg-slate-50 p-1.5 rounded-xl border border-slate-200 shadow-sm"><span class="text-xs font-bold text-slate-400 px-3 uppercase tracking-wider">Ano:</span><div class="flex gap-1" id="year-slicer"><button onclick="filterByYear(\'2025\')" id="btn-year-2025" class="slicer-btn slicer-active text-xs py-2 px-4">2025</button><button onclick="filterByYear(\'2026\')" id="btn-year-2026" class="slicer-btn text-xs py-2 px-4">2026</button></div></div><div class="flex items-center bg-slate-50 p-1.5 rounded-xl border border-slate-200 shadow-sm"><span class="text-xs font-bold text-slate-400 px-3 uppercase tracking-wider">Per√≠odo:</span><div class="flex gap-1" id="month-slicer"></div></div></div></div>';
                this.renderMonthSlicers('2025');
            },
            renderMonthSlicers: function(year) {
                var container = document.getElementById('month-slicer'); if (!container) return;
                var mesesConfig = MESES[year]; if (!mesesConfig) return;
                var html = '<button onclick="filterDashboard(\'all\')" id="btn-all" class="slicer-btn slicer-active text-xs py-2 px-3">Todos</button>';
                html += mesesConfig.labels.map((mes, idx) => `<button onclick="filterDashboard('${mes.toLowerCase()}')" id="btn-${mes.toLowerCase()}" class="slicer-btn text-xs py-2 px-3">${mes}</button>`).join('');
                container.innerHTML = html;
            },
            renderTabs: function() {
                var tabs = [
                    { id: 'overview', label: 'Vis√£o Executiva', icon: 'ph-chart-line-up' },
                    { id: 'conformidade', label: 'Conformidade', icon: 'ph-shield-check' },
                    { id: 'inspecao', label: 'Inspe√ß√µes', icon: 'ph-clipboard-text' },
                    { id: 'evacuacao', label: 'Evacua√ß√£o', icon: 'ph-users-three' },
                    { id: 'brigada', label: 'Brigada', icon: 'ph-identification-badge' }
                ];
                var container = document.getElementById('tab-navigation');
                container.innerHTML = tabs.map(tab => `<button onclick="switchTab('${tab.id}')" id="tab-btn-${tab.id}" class="pb-3 text-sm font-semibold border-b-2 flex items-center gap-2 transition-all ${tab.id==='overview'?'border-blue-600 text-blue-600':'border-transparent text-slate-500 hover:text-slate-800'}"><i class="ph ${tab.icon}"></i><span>${tab.label}</span></button>`).join('');
            },
            updateYearSlicerState: function(activeYear) { document.querySelectorAll('[id^="btn-year-"]').forEach(btn => btn.classList.remove('slicer-active')); document.getElementById('btn-year-' + activeYear).classList.add('slicer-active'); },
            updateSlicerState: function(activeMonth) { document.querySelectorAll('#month-slicer .slicer-btn').forEach(btn => btn.classList.remove('slicer-active')); var btn = document.getElementById('btn-' + activeMonth); if (btn) btn.classList.add('slicer-active'); },
            renderKPICards: function(data) {
                var container = document.getElementById('kpi-cards-container'); if (!container) return;
                container.innerHTML = `
                    <div class="kpi-card"><div class="absolute right-4 top-4 opacity-10"><i class="ph-fill ph-shield-check text-6xl text-blue-600"></i></div><div><h3 class="kpi-label">Conformidade Geral</h3><div class="mt-2 flex items-baseline gap-2"><span class="kpi-value" id="kpi-conformidade-value">${data.conformidade.toFixed(1)}%</span><span class="badge badge-success">Bom</span></div></div></div>
                    <div class="kpi-card"><div class="absolute right-4 top-4 opacity-10"><i class="ph-fill ph-warning-circle text-6xl text-orange-500"></i></div><div><h3 class="kpi-label">Obstru√ß√µes</h3><div class="mt-2 flex items-baseline gap-2"><span class="kpi-value" id="kpi-obstrucoes-value">${data.totalObstrucoes}</span><span class="badge badge-warning">Detectadas</span></div></div></div>
                    <div class="kpi-card"><div class="absolute right-4 top-4 opacity-10"><i class="ph-fill ph-timer text-6xl text-emerald-500"></i></div><div><h3 class="kpi-label">√öltimo Simulado</h3><div class="mt-2 flex items-baseline gap-2"><span class="kpi-value">03:12</span><span class="badge badge-success">Meta OK</span></div></div></div>
                    <div class="kpi-card"><div class="absolute right-4 top-4 opacity-10"><i class="ph-fill ph-users-three text-6xl text-purple-500"></i></div><div><h3 class="kpi-label">Brigada Efetiva</h3><div class="mt-2 flex items-baseline gap-2"><span class="kpi-value">55</span><span class="badge badge-info">50.5% Conv.</span></div></div></div>
                `;
            },
            renderInsights: function(year, month) {
                year = year || '2025'; month = month || 'all';
                var container = document.getElementById('dynamic-insights'); if (!container) return;
                var insights = DATABASE[year].insights[month] || DATABASE[year].insights.all;
                container.innerHTML = insights.map(text => `<div class="insight-card"><i class="ph-fill ph-lightbulb-filament text-blue-600 text-lg"></i><span class="text-xs text-slate-700 leading-relaxed">${text}</span></div>`).join('');
            },
            renderChecklistBars: function(execucaoData) {
                var container = document.getElementById('inspection-bars'); if (!container || !execucaoData) return;
                var items = [ { label: 'Extintores', value: execucaoData.extintores, ref: 201 }, { label: 'Hidrantes', value: execucaoData.hidrantes, ref: 60 }, { label: 'Lumin√°rias', value: execucaoData.luminarias, ref: 28 }, { label: 'Aterramento', value: execucaoData.aterramento, ref: 1 }, { label: 'Bombas', value: execucaoData.bombas, ref: 7 } ];
                container.innerHTML = items.map(item => {
                    var color = item.value >= 90 ? 'bg-green-500' : (item.value >= 70 ? 'bg-yellow-500' : 'bg-red-500');
                    return `<div class="group"><div class="flex justify-between items-center text-xs mb-1"><span class="font-medium text-slate-600">${item.label}</span><span class="font-bold text-slate-800">${item.value}%</span></div><div class="progress-bar-container"><div class="progress-bar-fill ${color}" style="width: ${item.value}%"></div></div></div>`;
                }).join('');
            }
        };

        // 5. VIEWS
        var Views = {
            renderOverview: function() {
                var container = document.getElementById('dashboard-content');
                container.innerHTML = `
                    <div id="content-overview" class="space-y-6">
                        <div id="kpi-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="flex justify-between items-center mb-4"><h3 class="text-slate-800 font-bold text-base">Evolu√ß√£o Mensal (%)</h3></div><div class="h-[280px] w-full relative"><canvas id="complianceChart"></canvas></div></div>
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col"><h3 class="text-slate-800 font-bold text-base mb-4">Destaques do Per√≠odo</h3><div id="dynamic-insights" class="space-y-3 flex-grow"></div></div>
                        </div>
                    </div>`;
                this.initializeOverview();
            },
            initializeOverview: function() {
                var currentYear = AppState.currentYear;
                var yearData = DATABASE[currentYear];
                var data = getMonthData(currentYear, 'all');
                Components.renderKPICards({ conformidade: data.conformidade, totalObstrucoes: data.totalObstrucoes });
                Components.renderInsights(currentYear, 'all');
                ChartManager.createConformidade('complianceChart', yearData.conformidade.labels, yearData.conformidade.values);
            },
            updateOverview: function(year, month) {
                var yearData = DATABASE[year];
                var data = getMonthData(year, month);
                animateValue('kpi-conformidade-value', data.conformidade.toFixed(1) + '%');
                animateValue('kpi-obstrucoes-value', data.totalObstrucoes);
                Components.renderInsights(year, month);
                if (month === 'all') ChartManager.update('complianceChart', yearData.conformidade.labels, yearData.conformidade.values);
                else {
                    var monthIndex = MESES[year].mapping[month];
                    if (monthIndex !== undefined) ChartManager.update('complianceChart', [yearData.conformidade.labels[monthIndex]], [yearData.conformidade.values[monthIndex]]);
                }
            },
            renderConformidade: function() {
                var container = document.getElementById('dashboard-content');
                container.innerHTML = `<div id="content-conformidade" class="space-y-6"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-slate-800 font-bold mb-4">Linha do Tempo</h3><div class="h-[320px] relative"><canvas id="complianceChartDetail"></canvas></div></div><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-slate-800 font-bold mb-4">Obstru√ß√µes Mensais</h3><div class="h-[320px] relative"><canvas id="obstructionsChart"></canvas></div></div></div></div>`;
                var yearData = DATABASE[AppState.currentYear];
                ChartManager.createConformidade('complianceChartDetail', yearData.conformidade.labels, yearData.conformidade.values);
                ChartManager.createObstrucoes('obstructionsChart', yearData.conformidade.labels, yearData.obstrucoes.extintores, yearData.obstrucoes.hidrantes);
            },
            renderInspecao: function() {
                var container = document.getElementById('dashboard-content');
                container.innerHTML = `<div id="content-inspecao" class="space-y-6"><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-slate-800 font-bold text-lg mb-6">Checklist de Conformidade por Sistema</h3><div id="inspection-bars" class="space-y-4 max-w-4xl"></div></div></div>`;
                var data = getMonthData(AppState.currentYear, 'all');
                Components.renderChecklistBars(data.execucao);
            },
            renderEvacuacao: function() {
                var container = document.getElementById('dashboard-content');
                container.innerHTML = `<div id="content-evacuacao" class="space-y-6"><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-slate-800 font-bold mb-4">Hist√≥rico de Simulados</h3><div class="h-[280px] w-full relative"><canvas id="evacuationChart"></canvas></div></div></div>`;
                var yearData = DATABASE[AppState.currentYear];
                ChartManager.createEvacuacao('evacuationChart', yearData.evacuacao.labels, yearData.evacuacao.tempos);
            },
            renderBrigada: function() {
                var container = document.getElementById('dashboard-content');
                var yearData = DATABASE[AppState.currentYear].brigada;
                var turmasHTML = yearData.turmas.map(t => `<tr><td class="font-semibold p-3 border-b">${t.mes}</td><td class="text-center p-3 border-b">${t.inscritos}</td><td class="text-center font-bold text-emerald-600 p-3 border-b">${t.treinados}</td><td class="text-center p-3 border-b text-xs">${t.validade}</td></tr>`).join('');
                container.innerHTML = `<div id="content-brigada" class="space-y-6"><div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 class="text-slate-800 font-bold text-base mb-4">Turmas de Capacita√ß√£o</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-slate-50"><th class="text-left p-3">Turma</th><th class="p-3">Inscritos</th><th class="p-3">Treinados</th><th class="p-3">Validade</th></tr></thead><tbody>${turmasHTML}</tbody></table></div></div></div>`;
            }
        };

        // 6. MAIN CONTROLLER
        var AppState = { currentTab: 'overview', currentYear: '2025', currentMonth: 'all' };

        window.initIndicadoresSystem = function() {
            console.log('üöÄ Inicializando Sistema de Indicadores...');
            ChartManager.init();
            Components.renderHeader();
            Components.renderTabs();
            Views.renderOverview();
        };

        window.switchTab = function(tabId) {
            AppState.currentTab = tabId;
            var allTabs = ['overview', 'conformidade', 'inspecao', 'evacuacao', 'brigada'];
            allTabs.forEach(id => {
                var btn = document.getElementById('tab-btn-' + id);
                if(btn) {
                    if(id === tabId) { btn.classList.remove('border-transparent', 'text-slate-500'); btn.classList.add('border-blue-600', 'text-blue-600'); }
                    else { btn.classList.remove('border-blue-600', 'text-blue-600'); btn.classList.add('border-transparent', 'text-slate-500'); }
                }
            });
            if(tabId === 'overview') Views.renderOverview();
            if(tabId === 'conformidade') Views.renderConformidade();
            if(tabId === 'inspecao') Views.renderInspecao();
            if(tabId === 'evacuacao') Views.renderEvacuacao();
            if(tabId === 'brigada') Views.renderBrigada();
        };

        window.filterByYear = function(year) {
            AppState.currentYear = year;
            Components.updateYearSlicerState(year);
            Components.renderMonthSlicers(year);
            switchTab(AppState.currentTab); // Reload view
        };

        window.filterDashboard = function(month) {
            AppState.currentMonth = month;
            Components.updateSlicerState(month);
            if(AppState.currentTab === 'overview') Views.updateOverview(AppState.currentYear, month);
        };

        // INICIALIZA√á√ÉO GERAL
        window.onload = () => {
            globalEditor.init(); 
            iconPicker.init();
            escalaApp.init(); 
        };

    </script>
</body>
</html>
